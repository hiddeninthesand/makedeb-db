---
kind: pipeline
type: docker
name: Configure PKGBUILDs

platform:
  os: linux
  arch: amd64

clone:
  disable: true

steps:
- name: Clone
  image: docker.hunterwittenborn.com/hwittenborn/drone-git
  settings:
    action: clone
    ssh_key:
      from_secret: kavplex_github_ssh_key
    ssh_known_hosts:
      from_secret: ssh_known_hosts

- name: Set Variables in PKGBUILDs
  image: ubuntu
  commands:
  - cd ${DRONE_REPO_NAME}
  - scripts/pkgbuild_gen.sh

- name: Push Modified PKGBUILDs Back to GitHub
  image: docker.hunterwittenborn.com/hwittenborn/drone-git
  settings:
    action: push
    message: Updated version in PKGBUILDs [CI SKIP]
    ssh_key:
      from_secret: kavplex_github_ssh_key
    ssh_known_hosts:
      from_secret: ssh_known_hosts

image_pull_secrets:
- nexus_repository_docker_login

---
kind: pipeline
type: docker
name: Build and Publish to APT Repository

platform:
  os: linux
  arch: amd64

clone:
  disable: true

steps:
- name: Clone
  image: docker.hunterwittenborn.com/hwittenborn/drone-git
  settings:
    action: clone
    ssh_key:
      from_secret: kavplex_github_ssh_key
    ssh_known_hosts:
      from_secret: ssh_known_hosts

- name: Build
  image: ubuntu
  commands:
  - cd ${DRONE_REPO_NAME}
  - scripts/build.sh
  environment:
    DEBIAN_FRONTEND: noninteractive

- name: Publish
  image: ubuntu
  commands:
  - cd ${DRONE_REPO_NAME}
  - scripts/publish.sh
  environment:
    DEBIAN_FRONTEND: noninteractive
    nexus_repository_password:
      from_secret: nexus_repository_password

image_pull_secrets:
- nexus_repository_docker_login

trigger:
  branch:
  - master

depends_on:
- Configure PKGBUILDs

---
kind: pipeline
type: docker
name: Publish to AUR

platform:
  os: linux
  arch: amd64

clone:
  disable: true

steps:
- name: Clone
  image: docker.hunterwittenborn.com/hwittenborn/drone-git
  settings:
    action: clone
    ssh_key:
      from_secret: kavplex_github_ssh_key
    ssh_known_hosts:
      from_secret: ssh_known_hosts

- name: Pull Git repository from AUR
  image: docker.hunterwittenborn.com/hwittenborn/drone-aur
  settings:
    action: clone
    pkgname: makedeb-db
    ssh_key:
      from_secret: kavplex_aur_ssh_key
    ssh_known_hosts:
      from_secret: ssh_known_hosts

- name: Replace AUR PKGBUILD with PKGBUILD from GitHub
  image: ubuntu
  commands:
  - makedeb-db/scripts/aur_pkgbuild_select.sh

- name: Push Release to AUR
  image: docker.hunterwittenborn.com/hwittenborn/drone-aur
  settings:
    action: push
    pkgname: makedeb-db
    ssh_key:
      from_secret: kavplex_aur_ssh_key
    ssh_known_hosts:
      from_secret: ssh_known_hosts

image_pull_secrets:
- nexus_repository_docker_login

trigger:
  branch:
  - master

depends_on:
- Build and Publish to APT Repository

...
